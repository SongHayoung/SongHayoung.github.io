<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="[CockroachDB] Replication Layer"><meta name="keywords" content="DB"><meta name="author" content="Song Hayoung"><meta name="copyright" content="Song Hayoung"><title>[CockroachDB] Replication Layer | SUMFIのBlog</title><link rel="shortcut icon" href="/songcon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-169368422-1', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"7LZ6OJ4D6C","apiKey":"9a84e13f74ea78c3fd54512c10139c56","indexName":"git blog","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss2.xml" title="SUMFIのBlog" type="application/rss+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Replication-Layer"><span class="toc-number">1.</span> <span class="toc-text">Replication Layer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">2.</span> <span class="toc-text">Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Interactions-with-other-layers"><span class="toc-number">2.1.</span> <span class="toc-text">Interactions with other layers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Technical-details-and-components"><span class="toc-number">3.</span> <span class="toc-text">Technical details and components</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Raft"><span class="toc-number">3.1.</span> <span class="toc-text">Raft</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Raft-logs"><span class="toc-number">3.1.1.</span> <span class="toc-text">Raft logs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Non-voting-replicas"><span class="toc-number">3.1.2.</span> <span class="toc-text">Non-voting replicas</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Per-replica-circuit-breakers"><span class="toc-number">3.1.3.</span> <span class="toc-text">Per-replica circuit breakers</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars3.githubusercontent.com/u/37806785?s=460&amp;u=8c68d685faf7c5280cfbd736a6b1730b55fb4203&amp;v=4"></div><div class="author-info__name text-center">Song Hayoung</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/hayoung-song-9523b61bb/">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">11390</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">198</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">62</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">VISITED</div><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Seoul Korea</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Jeju Korea</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">British Columbia Canada</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Boracay Philippines</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">三重　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">大阪　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">名古屋　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">静岡　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">札幌　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">京都　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Bangkok Thailand</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://xxxx.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">SUMFIのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">[CockroachDB] Replication Layer</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2024-02-11</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Cockroach-DB/">Cockroach DB</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">447</span><span class="post-meta__separator">|</span><span>Reading time: 2 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="Replication-Layer"><a href="#Replication-Layer" class="headerlink" title="Replication Layer"></a>Replication Layer</h2><span id="more"></span>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>고가용성을 위해서 데이터베이스가 애플레키에션에 대한 서비스를 중단하지 않고 노드가 오프라인 상태가 되는 것을 견딜 수 있어야 한다. 즉, 노드 간에 데이터를 복제해 데이터에 계속 액세스할 수 있도록 해야 한다.</p>
<p>Cockroach DB는 이 과제를 달성하기 위해 합의 알고리즘에 의존해 범위의 번경이 커밋되기 전에 복제본의 쿼럼이 변경에 동의하도록 요구한다. 3은 쿼럼을 달성할 수 있는 최소 수 이므로 Cockroach DB의 고가용성을 위해서는 3개의 노드가 필요하다.</p>
<p>허용 가능한 장애 수는 <em>(Replication factor - 1)/2</em> 다. 장애가 발생하면 자동으로 노드의 응답이 중지되었음을 인식하고 데이터를 재분배해 생존 가능성을 극대화하기 위해 노력한다. 새 노드가 클러스터에 가입하면 데이터가 자동으로 클러스터로 재조정되어 부하가 고르게 분산되도록 한다.</p>
<h3 id="Interactions-with-other-layers"><a href="#Interactions-with-other-layers" class="headerlink" title="Interactions with other layers"></a>Interactions with other layers</h3><ul>
<li>Destribution layer로 부터 요청을 수신하고 응답을 전송한다.</li>
<li>수락된 요청을 Storage layer에 쓴다.</li>
</ul>
<h2 id="Technical-details-and-components"><a href="#Technical-details-and-components" class="headerlink" title="Technical details and components"></a>Technical details and components</h2><h3 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h3><p>Raft는 합의 프로토콜로, 데이터를 여러 컴퓨터에 안전히 저장하고 일부 컴퓨터의 연결이 일시적으로 끊어지더라도 해당 컴퓨터가 현재 상태에 대해 동의하도록 하는 알고리즘이다.</p>
<p>Raft는 특정 범위의 복제본을 포함하는 모든 노드를 하나의 그룹으로 구성하는데, 이를 Raft 그룹이라 부른다. Raft 그룹의 각 레플리카는 리더 또는 팔로워다. Raft에 의해 선출되고 오래 살아남는 리더는 Raft 그룹에 대한 모든 쓰기를 조정한다. 리더는 팔로워들에게 주기적으로 하트비트를 보내고 로그를 복제한다. 하트비트가 없는 경우, 팔로워들은 무작위 선거 타임아웃 후 후보가 되어 새로운 리더 선거를 진행한다.</p>
<p>3번째 복제본 유형인 “non-voting” 복제본은 Raft 선거에 참여하지 않지만, 지연 시간이 짧은 다중 지역 읽기가 필요한 사용 사례를 지원하는데 유용하다. 노드가 포함된 범위에 대한 BatchRequest를 받으면 해당 KV 작업을 Raft 명령으로 변환한다. 이런 명령은 Raft 그룹 리더에게 제안되며 Raft log에 기록된다.</p>
<h4 id="Raft-logs"><a href="#Raft-logs" class="headerlink" title="Raft logs"></a>Raft logs</h4><p>쓰기가 정족수를 충족하고 Raft 그룹 리더에 의해 커밋되면 Raft 로그에 추가된다. 이것은 복제본이 동의한 명령의 정렬된 집합을 제공하며, 본질적으로 일관된 복제를 위한 진실 소스가 된다.</p>
<p>이 로그는 직렬화 가능한 것으로 취급되기 때문에 노드를 과거 상태에서 현재 상태로 되돌리기 위해 재생할 수 있다. 또한 이 로그를 사용하면 일시적으로 오프라인 상태가 된 노드를 스냅샷 형태로 기존 데이터의 사본을 받을 필요 없이 현재 상태로 따라잡을 수 있다.</p>
<h4 id="Non-voting-replicas"><a href="#Non-voting-replicas" class="headerlink" title="Non-voting replicas"></a>Non-voting replicas</h4><p>Raft 합의 프로토콜에서 투표자로만 구성된 복제본들은 모든 합의 알고리즘에 복제본이 참여해야 하기 때문에 복제 계수를 늘리면 Raft 쿼럼이 증가해 추가 쓰기 지연이 발생했다. 다중 지역 클러스터에 대한 개선을 위해 비투표 복제본이라는 개념이 도입된다. 비투표 복제본은 Raft log를 따르지만 쿼럼에는 참여하지 않는, 쓰기 지연 시간 개선을 위한 읽기 전용 복제본인 셈이다.</p>
<h4 id="Per-replica-circuit-breakers"><a href="#Per-replica-circuit-breakers" class="headerlink" title="Per-replica circuit breakers"></a>Per-replica circuit breakers</h4><p>개별 범위를 일시적으로 사용할 수 없게 되면 해당 범위에 대한 요청은 무한정 중단되는 대신 복제본별 circuit breaker 메커니즘에 의해 거부된다.</p>
<p>사용자 관점에서는 일시적으로 사용할 수 없는 범위에 액세스해 SQL 쿼리가 궁극적으로 실패할 경우 해당 범위에 있는 복제본이 서킷 브레이커를 작동 시키고 시스템을 통해 오류를 전파시킨다. 또한 범위의 가용성을 비동기적으로 계속 조사해 복제본을 다시 사용할 수 있게 되면 차단기가 재설정되어 정상적으로 요청을 다시 처리할 수 있다. 이런 기능은 일시적 오류에 대한 견고성을 갖추게해 클러스터 가용성을 더욱 높힌다.</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Song Hayoung</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://songhayoung.github.io/2024/02/11/Cockroach/replication-layer/">https://songhayoung.github.io/2024/02/11/Cockroach/replication-layer/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/DB/">DB</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2024/02/12/PS/Codeforces/div2-604-e/"><i class="fa fa-chevron-left">  </i><span>[Codeforces] Round 604 (Div. 2) E. Beautiful Mirrors</span></a></div><div class="next-post pull-right"><a href="/2024/02/11/PS/LeetCode/number-of-subarrays-that-match-a-pattern-ii/"><span>[LeetCode] Number of Subarrays That Match a Pattern II</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '3604b61642355579f55e',
  clientSecret: 'f552120f18ac5aee3f6297e05e97d94c0a25cd4b',
  repo: 'SongHayoung.github.io',
  owner: 'SongHayoung',
  admin: 'SongHayoung',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://xxxx.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2025 By Song Hayoung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Learning how to walk slowly to not miss important things</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/algolia.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>