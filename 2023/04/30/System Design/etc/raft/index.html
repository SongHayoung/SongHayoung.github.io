<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="[System Design] Raft consensus algorithm"><meta name="keywords" content="System Design"><meta name="author" content="Song Hayoung"><meta name="copyright" content="Song Hayoung"><title>[System Design] Raft consensus algorithm | SUMFIのBlog</title><link rel="shortcut icon" href="/songcon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-169368422-1', 'auto');
ga('send', 'pageview');</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"7LZ6OJ4D6C","apiKey":"9a84e13f74ea78c3fd54512c10139c56","indexName":"git blog","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss2.xml" title="SUMFIのBlog" type="application/rss+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Raft"><span class="toc-number">1.</span> <span class="toc-text">What is Raft?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hold-on-what-is-consensus"><span class="toc-number">2.</span> <span class="toc-text">Hold on - what is consensus?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Distributed-Consensus-in-Raft"><span class="toc-number">3.</span> <span class="toc-text">What is Distributed Consensus in Raft?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">4.</span> <span class="toc-text">Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leader-election"><span class="toc-number">4.1.</span> <span class="toc-text">Leader election</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Log-replication"><span class="toc-number">4.2.</span> <span class="toc-text">Log replication</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Low-level-design"><span class="toc-number">5.</span> <span class="toc-text">Low level design</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leader-election-1"><span class="toc-number">5.1.</span> <span class="toc-text">Leader election</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Log-replication-1"><span class="toc-number">5.2.</span> <span class="toc-text">Log replication</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-Visualization"><span class="toc-number">6.</span> <span class="toc-text">Raft Visualization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ref"><span class="toc-number">7.</span> <span class="toc-text">ref</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars3.githubusercontent.com/u/37806785?s=460&amp;u=8c68d685faf7c5280cfbd736a6b1730b55fb4203&amp;v=4"></div><div class="author-info__name text-center">Song Hayoung</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/hayoung-song-9523b61bb/">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">10719</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">193</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">61</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">VISITED</div><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Seoul Korea</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Jeju Korea</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">British Columbia Canada</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Boracay Philippines</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">三重　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">大阪　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">名古屋　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">静岡　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">札幌　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">京都　日本</a><a class="author-info-links__name text-center" href="https://songhayoung.github.io/">Bangkok Thailand</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://xxxx.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">SUMFIのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">[System Design] Raft consensus algorithm</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-04-30</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/System-Design/">System Design</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/System-Design/Etc/">Etc</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">876</span><span class="post-meta__separator">|</span><span>Reading time: 5 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="What-is-Raft"><a href="#What-is-Raft" class="headerlink" title="What is Raft?"></a>What is Raft?</h2><span id="more"></span>
<p>Raft는 이해하기 쉽도록 설계된 합의 알고리즘이다. 내결함성 및 성능 면에서 Paxos와 동일하다. 차이점은 비교적 독립적인 하위 문제로 분해되어 있으며, 실제 시스템에 필요한 모든 주요 부분을 깔끔하게 해결한다는 것이다.</p>
<h2 id="Hold-on-what-is-consensus"><a href="#Hold-on-what-is-consensus" class="headerlink" title="Hold on - what is consensus?"></a>Hold on - what is consensus?</h2><p>합의는 내결함성 분산 시스템의 근본적인 문제이다. 합의는 여러 서버가 그 가치에 동의하는 내용을 포함한다. 한 서버가 값에 대한 결정에 도달하면 그 결정이 최종 결정이 된다. 일반적인 합의 알고리즘은 과반수의 서버를 사용할 수 있을 때 진행된다. 예를 들어 5대의 노드로 구성된 클러스터의 경우 2대의 노드 실패까지 내결함성을 지닌다. 더 많은 노드의 실패가 발생하면 중단되지만 잘못된 결과를 반환하지는 않는다.</p>
<p>합의는 일반적으로 내결함성 시스템을 구축하기 위한 일반적인 접근 방식인 복제된 상태 머신의 맥락에서 발생한다. 각 서버에는 상태 머신과 로그가 있다. 상태 머신은 해시 테이블과 같이 동작하며 내결함성을 갖추기 위한 구성요소다. 클라이언트는 클러스터의 일부 서버에 장애가 발생하더라도 신뢰할 수 있는 단일 상태 머신과 상호 작용하고 있는 것 처럼 보인다. 각 상태 머신은 로그에서 명령을 입력으로 받는다. 해시 테이블에는 <code>set x to 3</code>과 같이 값을 설정하는 등의 명령이 포함된다. 합의 알고리즘은 서버 로그의 명령에 동의하는데 사용된다. 합의 알고리즘은 어떤 상태 머신이 n번째 명령으로 <code>set x to 3</code>을 적용할 경우 다른 상태 머신이 다른 n번째 명령을 반영하지 않도록 보장해야 한다. 결과적으로 각 상태 머신은 동일한 일련의 명령을 처리하므로 동일한 일련의 결과를 생성하고 동일한 일련의 상태에 도달하게 된다.</p>
<h2 id="What-is-Distributed-Consensus-in-Raft"><a href="#What-is-Distributed-Consensus-in-Raft" class="headerlink" title="What is Distributed Consensus in Raft?"></a>What is Distributed Consensus in Raft?</h2><p>단일 노드가 시스템에 존재한다고 가정하자. 이 가정에서는 노드를 단일 값을 저장하는 데이터베이스 서버로 생각할 수 있다. 또한 서버로 값을 전송할 수 있는 클라이언트도 있다. 단일 노드에서 하나의 명령에 대한 합의는 쉽게 진행할 수 있다. 하지만 여러 노드가 존재하는 상태에서는 어떻게 합의에 도달할 수 있을까? 이것이 바로 분산 합의의 문제다. Raft는 분산 합의를 구현하기 위한 프로토콜이다. 동작 방식에 대한 간략한 개요부터 살펴보자.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>단일 노드는 3가지의 상태를 가질 수 있다.</p>
<ul>
<li>Follower state</li>
<li>Candidate state</li>
<li>Leader state</li>
</ul>
<h3 id="Leader-election"><a href="#Leader-election" class="headerlink" title="Leader election"></a>Leader election</h3><p>모든 노드는 follower state로 시작한다. 만약 팔로워가 리더로부터 연락(heart beat)를 받지 못하면 후보가 될 수 있다. 그런 다음 후보자가 다른 노드에 투표를 요청한다. 노드들은 그들의 투표로 응답을 보낸다. 후보가 과반수의 노드로부터 표를 얻으면 리더가 된다. 이 프로세스를 리더 선출(Leader Election)이라 한다. </p>
<h3 id="Log-replication"><a href="#Log-replication" class="headerlink" title="Log replication"></a>Log replication</h3><p>이제 시스템에 대한 모든 변경 사항은 리더를 통해 이루어진다. 각 변경 사항은 노드의 로그에 추가된다. 이 로그 항목은 현재 커밋되지 않은 상태라 노드 값을 업데이트 하지 않는다. 항목을 커밋하기 위해 노드는 먼저 팔로워 노드에 해당 항목을 복제한다. 그런 다음 리더는 대다수의 노드가 엔트리에 해당 값을 작성할 때 까지 기다린다. 응답은 받은 리더는 값을 커밋하고 팔로워들에게 값이 커밋됨을 통지한다. 이런 방식으로 클러스터는 시스템 상태에 대한 합의에 도달하게 된다. 이 프로세스를 로그 복제(Log Replication)이라 한다.</p>
<h2 id="Low-level-design"><a href="#Low-level-design" class="headerlink" title="Low level design"></a>Low level design</h2><h3 id="Leader-election-1"><a href="#Leader-election-1" class="headerlink" title="Leader election"></a>Leader election</h3><p>Raft에서는 선거를 제어하기 위해 두 가지 타임아웃이 존재한다. 첫번째는 <code>election timeout</code>이다. Election timeout은 팔로워가 후보자가 될 때 까지 기다리는 시간이다. 이 시간은 150ms에서 300ms까지 무작위로 지정된다. Election timeout이 지나면 팔로워는 후보자가 되어 새로운 election term을 시작하고 스스로에게 투표한다. 그런 다음 다른 노드들에게 투표 요청 메세지를 보낸다. 수신 노드가 이번 term에 아직 투표하지 않은 경우 후보자에게 투표한다. 그리고 수신 노드 스스로 election timeout을 재설정한다. 과반수의 표를 얻은 후보는 리더로 승격한다. </p>
<p>이제 리더는 팔로워들에게 append entries 메세지를 보내기 시작한다. 이 메세지는 <code>heartbeat timeout</code>으로 지정된 간격을 가지는 주기로 전송된다. 그런 다음 팔로워가 각 append entries 메세지에 응답한다. 이 term은 팔로워가 heartbeat 수신을 중단하고 후보자가 될 때 까지 지속된다.</p>
<p>리더가 중지되고 재선거는 어떤 방식으로 진행되는지 살펴보자. 하트비트를 받지 못한 노드는 timeout이 발생하고 후보자가 된다. 후보자는 위에서 언급한 내용과 동일하게 election term을 시작하고 클러스터에 투표를 진행하게 된다. 리더가 되기 위해선 과반의 득표가 필요하기 때문에 term당 한 명의 리더만 선출되게 된다.</p>
<p>두 개 이상의 노드가 동시에 후보가 되면 분할 투표가 발생할 수 있다. 분할 투표 시나리오를 살펴보자. 클러스터에는 4개의 노드가 존재하고, 그 중 2개의 두 노드(A, B)가 동시에 후보자가 되어 같은 term에 선거를 시작한다. 그리고 후보자 각각의 투표 요청은 각각의 노드에 도착하게 된다. C는 A에게, D는 B에게 투표하여 각 후보자에게는 2표씩 득표했기 때문에 이번 term에는 더 이상 표를 받을 수 없게 된다. 노드는 새로운 선거를 기다렸다가 다시 시도한다. 이 과정을 통해 최종적으로 하나의 노드만 리더로 선출된다.</p>
<h3 id="Log-replication-1"><a href="#Log-replication-1" class="headerlink" title="Log replication"></a>Log replication</h3><p>리더가 선출되면 시스템에 대한 모든 변경 사항을 모든 노드에 복제해야 한다. 이 과정은 하트비트에 사용되는 것과 동일한 append entries 메세지를 통해 이루어진다. 이 프로세스를 살펴보자. 먼저 클라이언트가 리더에게 변경 사항을 전송한다. 이 변경사항은 리더의 로그에 추가되고 다음 하트비트 메세지에 팔로워들에게 변경 사항을 실어 전송한다. 과반의 팔로워가 승인하면 항목이 커밋되고 응답이 클라이언트로 전송된다.</p>
<p>Raft는 네트워크 파티션에 있어서도 일관성을 유지할 수 있다. 클러스터에 5개의 노드가 있고 <code>&#123;A,B&#125;, &#123;C,D,E&#125;</code>로 파티션이 분리되었다고 가정하자. 파티션이 분리된 C D E(파티션 2)에서는 새로운 리더를 선출하게 되고, 네트워크 파티션으로 인해 서로 다른 term을 가지는 두 명의 리더를 가지게 된다. 이제 서로 다른 클라이언트가 두 리더를 업데이트 한다고 가정하자. 클라이언트는 파티션 1로 요청을 보냈지만, 파티션 1의 리더 A는 과반의 노드가 동의하지 않아 로그 항목이 커밋되지 않은 상태로 유지된다.  다른 클라이언트는 파티션 2의 리더 C에 요청을 보낸다. 리더 C는 과반의 노드가 복제에 동의했기 때문에 명령이 성공적으로 수행된다. 이제 네트워크 파티션이 복구되었다 가정하자. 노드 A는 노드 C가 가지는 더 높은 term을 보고 물러나게 된다. 노드 A와 B는 모두 커밋되지 않은 항목을 롤백하고 C의 로그와 일치 시킨다. 이 과정을 통해서 클러스터 전체에 로그의 일관성을 유지하게 된다.</p>
<h2 id="Raft-Visualization"><a href="#Raft-Visualization" class="headerlink" title="Raft Visualization"></a>Raft Visualization</h2><iframe src="https://raft.github.io/raftscope/index.html" width="800" height="580" frameborder="0" loading="lazy" allowfullscreen></iframe>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><ul>
<li><a href="https://songhayoung.github.io/pdf/raft.pdf">raft</a></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Song Hayoung</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://songhayoung.github.io/2023/04/30/System%20Design/etc/raft/">https://songhayoung.github.io/2023/04/30/System%20Design/etc/raft/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/System-Design/">System Design</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/05/01/PS/LeetCode/index-pairs-of-a-string/"><i class="fa fa-chevron-left">  </i><span>[LeetCode] Index Pairs of a String</span></a></div><div class="next-post pull-right"><a href="/2023/04/30/System%20Design/etc/rsync-algorithm/"><span>[System Design] Rsync Algorithm</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '3604b61642355579f55e',
  clientSecret: 'f552120f18ac5aee3f6297e05e97d94c0a25cd4b',
  repo: 'SongHayoung.github.io',
  owner: 'SongHayoung',
  admin: 'SongHayoung',
  id: md5(decodeURI(location.pathname)),
  language: 'en'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://xxxx.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2024 By Song Hayoung</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Learning how to walk slowly to not miss important things</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/algolia.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>